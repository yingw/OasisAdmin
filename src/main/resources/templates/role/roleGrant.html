<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout.html}"
      th:with="menu='examples', subMenu='blank'">
<head>
  <meta charset="utf-8" th:remove="all">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" th:remove="all">
  <title>Example</title>
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport" th:remove="all">
  <!-- Bootstrap 3.3.7 -->
  <link rel="stylesheet" href="../../static/bower_components/bootstrap/dist/css/bootstrap.min.css" th:remove="all">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="../../static/bower_components/font-awesome/css/font-awesome.min.css" th:remove="all">
  <!-- Ionicons -->
  <link rel="stylesheet" href="../../static/bower_components/Ionicons/css/ionicons.min.css" th:remove="all">
  <!-- DataTables -->
  <link rel="stylesheet" href="../../static/bower_components/datatables.net-bs/css/dataTables.bootstrap.min.css" th:remove="all">
  <!-- Theme style -->
  <link rel="stylesheet" href="../../static/css/AdminLTE.min.css" th:remove="all">


  <!-- Ztree -->
  <link rel="stylesheet"
        href="../../static/bower_components/zTree/css/zTreeStyle/zTreeStyle.css"
        th:href="@{/bower_components/zTree/css/zTreeStyle/zTreeStyle.css}">

  <!-- AdminLTE Skins. Choose a skin from the css/skins
       folder instead of downloading all of them to reduce the load. -->
  <link rel="stylesheet" href="../../static/css/skins/_all-skins.min.css" th:remove="all">
</head>
<body class="hold-transition skin-blue sidebar-mini">
<!-- Site wrapper -->
<div class="wrapper">

  <!-- Main Header -->
  <header class="main-header">
    <!-- Logo -->
    <a href="#" class="logo"></a>
    <!-- Header Navbar: style can be found in header.less -->
    <nav class="navbar navbar-static-top">
      <!-- Sidebar toggle button 缩进菜单的按钮 -->
      <a href="#" class="sidebar-toggle" data-toggle="push-menu" role="button"></a>
    </nav>
  </header>

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper" layout:fragment="content">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <h1>
        Blank page
        <small>it all starts here</small>
      </h1>
      <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
        <li><a href="#">Examples</a></li>
        <li class="active">Blank page</li>
      </ol>
    </section>

    <!-- Main content -->
    <section class="content">

      <!-- Default box -->
      <div class="box">
        <div class="box-header with-border">
          <h3 class="box-title">Title</h3>

          <div class="box-tools pull-right">
            <button type="button" class="btn btn-box-tool" data-widget="collapse" data-toggle="tooltip"
                    title="Collapse">
              <i class="fa fa-minus"></i></button>
            <button type="button" class="btn btn-box-tool" data-widget="remove" data-toggle="tooltip" title="Remove">
              <i class="fa fa-times"></i></button>
          </div>
        </div>
        <div class="box-body">

          <ul id="resourceTree" class="ztree"></ul>

        </div>
        <!-- /.box-body -->
        <div class="box-footer text-right">
          <button class="btn btn-primary" type="button" id="btn-submit"><i class="fa fa-save"></i>
            <span> 更新</span>
          </button>
        </div>
        <!-- /.box-footer-->
      </div>
      <!-- /.box -->

    </section>
    <!-- /.content -->
  </div>
  <!-- /.content-wrapper -->

  <!-- Main Footer -->
  <footer class="main-footer">
    <strong>&nbsp;</strong>
  </footer>

</div>
<!-- ./wrapper -->

<!-- jQuery 3 -->
<script src="../../static/bower_components/jquery/dist/jquery.min.js" th:remove="all"></script>
<!-- Bootstrap 3.3.7 -->
<script src="../../static/bower_components/bootstrap/dist/js/bootstrap.min.js" th:remove="all"></script>
<!-- DataTables -->
<script src="../../static/bower_components/datatables.net/js/jquery.dataTables.min.js" th:remove="all"></script>
<script src="../../static/bower_components/datatables.net-bs/js/dataTables.bootstrap.min.js" th:remove="all"></script>
<!-- SlimScroll -->
<script src="../../static/bower_components/jquery-slimscroll/jquery.slimscroll.min.js" th:remove="all"></script>
<!-- FastClick -->
<script src="../../static/bower_components/fastclick/lib/fastclick.js" th:remove="all"></script>
<!-- AdminLTE App -->
<script src="../../static/js/adminlte.min.js" th:remove="all"></script>
<!-- AdminLTE for demo purposes -->
<script src="../../static/js/demo.js" th:remove="all"></script>


<div layout:fragment="customScript">
  <!-- Ztree -->
  <script
        src="../../static/bower_components/zTree/js/jquery.ztree.all.min.js"
        th:src="@{/bower_components/zTree/js/jquery.ztree.all.min.js}"></script>

  <script th:inline="javascript">
      <!--
      var setting = {
          check : {
              enable : true
          },
          data : {
              simpleData : {
                  enable : true
              }
          }
      };
      setting.check.chkboxType = {
          "Y" : "ps",
          "N" : "s"
      };
//      一个小问题 pId 默认 get set 方法转成 json 变成 pid，应该是 pId，需要手动设置 get set 访问为 getpId setpId，也可以这样覆盖设置 pid 字段（参考文档：http://www.treejs.cn/v3/api.php）：
      setting.data.simpleData.pIdKey = "pid";

      $.ajax({
          type: "POST",
//              ${ctx}
          url: "[[${ctx}]]/roles/[[${role.id}]]/tree",
          dataType: 'json',
          success: function (msg) {
//              alert(msg);
              $.fn.zTree.init($("#resourceTree"), setting, msg);
          }
      });
/*
      var zNodes =[
          { name:"父节点1 - 展开", open:true,
              children: [
                  { name:"父节点11 - 折叠",
                      children: [
                          { name:"叶子节点111"},
                          { name:"叶子节点112"},
                          { name:"叶子节点113"},
                          { name:"叶子节点114"}
                      ]},
                  { name:"父节点12 - 折叠",
                      children: [
                          { name:"叶子节点121"},
                          { name:"叶子节点122"},
                          { name:"叶子节点123"},
                          { name:"叶子节点124"}
                      ]},
                  { name:"父节点13 - 没有子节点", isParent:true}
              ]},
          { name:"父节点2 - 折叠",
              children: [
                  { name:"父节点21 - 展开", open:true,
                      children: [
                          { name:"叶子节点211"},
                          { name:"叶子节点212"},
                          { name:"叶子节点213"},
                          { name:"叶子节点214"}
                      ]},
                  { name:"父节点22 - 折叠",
                      children: [
                          { name:"叶子节点221"},
                          { name:"叶子节点222"},
                          { name:"叶子节点223"},
                          { name:"叶子节点224"}
                      ]},
                  { name:"父节点23 - 折叠",
                      children: [
                          { name:"叶子节点231"},
                          { name:"叶子节点232"},
                          { name:"叶子节点233"},
                          { name:"叶子节点234"}
                      ]}
              ]},
          { name:"父节点3 - 没有子节点", isParent:true}
      ];
      $(document).ready(function(){
          $.fn.zTree.init($("#treeDemo"), setting, zNodes);
      });
*/
      //-->

    $("#btn-submit").click(function () {
        var treeObj = $.fn.zTree.getZTreeObj("resourceTree");
        var nodes = treeObj.getCheckedNodes(true);
        var selectIds="";
        for(var index in nodes){
            var item=nodes[index];
            selectIds+=item.id+",";
        }
//        alert(selectIds);
        $.ajax({
            url : "/roles/[[${role.id}]]/grant",
            type : "POST",
            dataType : "json",
            data : {"resourceIds":selectIds},
            success : function() {
//                alert();
                window.location.href = '/roles';
            },
            error : function(r,s,m) {
                alert("error!");
//                alert(m);
            }
        });
    });
  </script>
</div>

</body>
</html>
